# Performing efficiency studies using DQM Offline framework
see also https://twiki.cern.ch/twiki/bin/viewauth/CMS/HLTValidationAndDQM (outdated recipe based on 2018)


## Setup

```bash
cmsrel CMSSW_12_2_0_pre2
cd CMSSW_12_2_0_pre2/src
cmsenv
git cms-addpkg HLTrigger/Configuration
git cms-addpkg DQMOffline/Trigger
git cms-addpkg HLTriggerOffline/Common
git cms-merge-topic  silviodonato:customizeHLTforRun3_v2
git clone -b dev https://github.com/wonpoint4/RecoMuon-TrackerSeedGenerator.git RecoMuon/TrackerSeedGenerator/data
scram b -j 32
hltGetConfiguration  /dev/CMSSW_12_1_0/GRun --cff --offline --setup /dev/CMSSW_12_1_0/GRun --type GRun --unprescale --globaltag auto:phase1_2021_realistic --mc --max-events 10 --eras Run3 > HLT_User_cff.py
cp setup_dev_CMSSW_12_1_0_GRun_cff.py HLTrigger/Configuration/python/
cp HLT_User_cff.py HLTrigger/Configuration/python/
scram b -j 32
```

Change this line in `HLTrigger/Configuration/python/HLT_User_cff.py`

```python
fragment.load("setup_dev_CMSSW_12_1_0_GRun_cff")
```

to this

```python
fragment.load("HLTrigger.Configuration.setup_dev_CMSSW_12_1_0_GRun_cff")
```

And add these lines at the end of HLT_User_cff.py for e.g. noCaloROIPF plus Muon plus tracking customizer:

```python
from HLTrigger.Configuration.customizeHLTforRun3 import *
fragment = TRK_newTracking(fragment)
fragment = MUO_newReco(fragment)
fragment = BTV_noCalo_roiPF_DeepJet(fragment)
```

Get the latest customizer versions:

```bash
cd $CMSSW_BASE/src/HLTrigger/Configuration/python/Run3/
./downloadCustomizationFunctions.sh
```

Copy the updated files needed for DQM Offline validation of the HLT paths:

```bash
cp BTaggingMonitor_cfi.py $CMSSW_BASE/src/DQMOffline/Trigger/python/
cp BTaggingMonitoring_cff.py $CMSSW_BASE/src/DQMOffline/Trigger/python/
scram b -j 32
```

## Step 0: re-run the HLT

```bash
cmsDriver.py step0  -s  DIGI:pdigi_valid,L1,DIGI2RAW,HLT:User --conditions auto:phase1_2021_realistic --datatier GEN-SIM-DIGI-RAW -n 10 --eventcontent FEVTDEBUGHLT --mc --geometry DB:Extended --era Run3 --filein /store/mc/Run3Winter21DRMiniAOD/QCD_Pt-120To170_MuEnrichedPt5_TuneCP5_14TeV-pythia8/GEN-SIM-DIGI-RAW/FlatPU30to80FEVT_112X_mcRun3_2021_realistic_v16-v3/270000/0012597c-8497-4d8a-8f01-f555656838a0.root --process reHLT --customise_commands "process.dropCommands=process.RAWSIMEventContent.clone()\nprocess.dropCommands.outputCommands.extend(process.source.inputCommands[1:])\nprocess.source.inputCommands = process.dropCommands.outputCommands"
```

## Step 1: run validation and DQM sequences

```bash
cmsDriver.py step1  -s RAW2DIGI,L1Reco,RECO,RECOSIM,EI,VALIDATION,DQM --conditions auto:phase1_2021_realistic --mc --datatier DQMIO -n 10 --eventcontent DQM --geometry DB:Extended --era Run3 --filein file:step0_DIGI_L1_DIGI2RAW_HLT.root
```

## Step 2: run harvesting to get DQM histograms

```bash
cmsDriver.py step2 -s HARVESTING:validationHarvesting+dqmHarvesting --harvesting AtRunEnd --conditions auto:phase1_2021_realistic --mc  --geometry DB:Extended --scenario pp --filetype DQM --era Run3 -n 10 --filein file:step1_RAW2DIGI_L1Reco_RECO_RECOSIM_EI_VALIDATION_DQM.root
```
Using `extract_plots.py`, the histograms can be extracted from the resulting step2 output root file.

## Running with crab:

Configs usable with crab can be generated by using `--no_exec` in the cmsDriver commands (for step0 and step1). A set of example crab configs can be found in folder `crab`.

## Remarks:

1. Instead of dumping a file called HLT_User_cff.py, other names can be chosen as well: `HLT_<NAME>_cff.py`, which requires an adjustment in the cmsDriver commands: `HLT:<NAME>`.
2. Currently(?), the publication of the output of the step1 crab jobs does not work. Make sure that you write the output of step1 to a tier, which you can access without publication information! Step2 can be run locally, e.g.:
```bash
cmsDriver.py step2 -s HARVESTING:validationHarvesting+dqmHarvesting --harvesting AtRunEnd --conditions auto:phase1_2021_realistic --mc  --geometry DB:Extended --scenario pp --filetype DQM --era Run3 -n 10 --filein file:120-170/step1_RAW2DIGI_L1Reco_RECO_RECOSIM_EI_VALIDATION_DQM_1.root,file:120-170/step1_RAW2DIGI_L1Reco_RECO_RECOSIM_EI_VALIDATION_DQM_2.root,file:20-30/step1_RAW2DIGI_L1Reco_RECO_RECOSIM_EI_VALIDATION_DQM_1.root,file:20-30/step1_RAW2DIGI_L1Reco_RECO_RECOSIM_EI_VALIDATION_DQM_2.root,file:80-120/step1_RAW2DIGI_L1Reco_RECO_RECOSIM_EI_VALIDATION_DQM_1.root,file:30-50/step1_RAW2DIGI_L1Reco_RECO_RECOSIM_EI_VALIDATION_DQM_1.root,file:30-50/step1_RAW2DIGI_L1Reco_RECO_RECOSIM_EI_VALIDATION_DQM_2.root,file:30-50/step1_RAW2DIGI_L1Reco_RECO_RECOSIM_EI_VALIDATION_DQM_3.root,file:30-50/step1_RAW2DIGI_L1Reco_RECO_RECOSIM_EI_VALIDATION_DQM_4.root,file:50-80/step1_RAW2DIGI_L1Reco_RECO_RECOSIM_EI_VALIDATION_DQM_1.root
```
